#!/bin/bash
#
#::                                    VPN Server Firewall configuration script
#::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
#::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
#:: Author:   	SLS
#:: Verssion 1.06
#::
#::	Monday 27 November, 2017  - SLS.
#::		* File originally created.
#::		* Added setup actions to auto login and auto start router on reboot
#::
#::	Purpose: The purpose of the script is to setup iptables (Fire Wall) so that it will forward all traffic through
#:: 		 a vpn (tun0) and block all traffic if the VPN is down for any reason. This will ensure that
#:: 		 traffic is not accidentally exposed to evil authorities.
#::              - Local interface is "ens3"
#::              - VPN tunnel interface is "tun0"
#:: 		If either of these are different on your system you must change these in the script.
#::		The script will, however, try to identify the primary local newtork interface.
#::
#:: You may for example deploy a Debian based VM, and install your preferred VPN, run this script,
#:: and then configure your client devices to (via DHCP) route all traffic through the VM's IP address.
#:: This will ensure that all traffic from your LAN to the internet is anonymized, and that traffic is blocked if not.
#::
#::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
#::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::


#::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
#::::::::::::::                                          ::::::::::::::::::::::
#::::::::::::::          Script Settings                 ::::::::::::::::::::::
#::::::::::::::                                          ::::::::::::::::::::::
#::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::

# Fail fast on unset vars and pipeline errors where reasonable
set -o errexit
set -o pipefail
set -o nounset

# Environment override settings (allow caller to set before running)
: "${_LOCALINT:=}"
: "${_VPNINT:=}"
: "${_LOCALNET:=}"
: "${_LOCALSUB:=24}"
: "${_HOMEDIR:="$HOME"}"
: "${_branding:=VPN Router}"
: "${me:=${0##*/}}"
: "${RED:=}"
: "${YELLOW:=}"
: "${ENDCOLOR:=}"

NORDVPN_DEB="https://repo.nordvpn.com/deb/nordvpn/debian/pool/main/nordvpn-release_1.0.0_all.deb"
NORDVPN_RPM="https://repo.nordvpn.com/yum/nordvpn/centos/noarch/Packages/n/nordvpn-release-1.0.0-1.noarch.rpm"

# Require root; preserve invoking user for safe use
if [[ "${EUID}" -ne 0 ]]; then
	echo "This script needs administrative access..."
	exec sudo -H SUDO_USER="${SUDO_USER:-$USER}" bash "$0" "$@"
fi

if [[ -z "${SUDO_USER:-}" ]]; then
	echo "SUDO_USER is not set; run via sudo from a non-root account."
	exit 1
fi



#::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
#::::::::::::::                                          ::::::::::::::::::::::
#::::::::::::::          Setup routing for VPN           ::::::::::::::::::::::
#::::::::::::::                                          ::::::::::::::::::::::
#::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::

find_active_newtork_interface (){
	# Prefer interface used for default route
	if [[ -z "${_LOCALINT}" ]]; then
		_LOCALINT=$(ip route show default 2>/dev/null | awk '{print $5}' | head -n1)
	fi
	if [[ -z "${_LOCALINT}" ]]; then
		echo "Failed to determine local interface; please set _LOCALINT and rerun."
		exit 1
	fi
	echo "Active network interface is: ${_LOCALINT}"
}

derive_local_network() {
	if [[ -n "${_LOCALNET}" ]]; then
		return 0
	fi

	local cidr
	cidr=$(ip -4 -o addr show dev "${_LOCALINT}" 2>/dev/null | awk '{print $4}' | head -n1 || true)
	if [[ -z "$cidr" ]]; then
		echo "Failed to derive local network for ${_LOCALINT}; please set _LOCALNET and _LOCALSUB."
		exit 1
	fi
	_LOCALNET=${cidr%/*}
	_LOCALSUB=${cidr#*/}
	echo "Derived local network: ${_LOCALNET}/${_LOCALSUB}"
}

find_active_bridge_interface () {
	# Discover VPN tunnel interface (default tun0) unless overridden
	if [[ -z "${_VPNINT}" ]]; then
		if ip link show tun0 &>/dev/null; then
			_VPNINT="tun0"
		else
			_VPNINT=$(ip -o link show | awk -F': ' '/: tun[0-9]+/ {print $2; exit}')
		fi
	fi
	if [[ -z "${_VPNINT}" ]]; then
		echo "Failed to determine VPN interface; please set _VPNINT and rerun."
		exit 1
	fi
	echo "VPN interface is: ${_VPNINT}"
}




software::check_native_package_dependency () {
	#---------------------------------------------------------------
	echo "Checking for script dependencies and install if not there..."
	#---------------------------------------------------------------
	if hash "$1" 2>/dev/null; then
		echo "I found that $1 is present on this system... thankyou for that! "
	else
		echo "You seem to have no $1... I will try to get it... "
		if ! install_software "$1"; then
			echo "That install didn't work out so well."
			echo "Please manually try to add the software since I couldn't do it."
			exit 1
		fi
		echo "OK Done! Continuing..."
	fi
}



setup_routing_for_vpn () {
	echo #---------------------------------------------------------------
	echo "Checking for iptables and install if not there..."
	echo #---------------------------------------------------------------
	software::check_native_package_dependency iptables

	derive_local_network

	echo #---------------------------------------------------------------
	echo "Removing old rules and tables..."
	echo #---------------------------------------------------------------
	iptables -F
	iptables -X
	iptables -t nat -F
	iptables -t nat -X
	iptables -t mangle -F
	iptables -t mangle -X

	echo #---------------------------------------------------------------
	echo "Default Policy - Drop everything!"
	echo #---------------------------------------------------------------
	iptables -P INPUT DROP
	iptables -P FORWARD DROP
	iptables -P OUTPUT DROP

	echo #---------------------------------------------------------------
	echo "Allow loopback and established connections."
	echo #---------------------------------------------------------------
	iptables -A INPUT  -i lo  -j ACCEPT
	iptables -A OUTPUT -o lo  -j ACCEPT
	iptables -A INPUT -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT
	iptables -A OUTPUT -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT

	echo #---------------------------------------------------------------
	echo "Allow LAN traffic on local interface."
	echo #---------------------------------------------------------------
	iptables -A INPUT  -i "${_LOCALINT}" -s "${_LOCALNET}/${_LOCALSUB}" -j ACCEPT
	iptables -A OUTPUT -o "${_LOCALINT}" -d "${_LOCALNET}/${_LOCALSUB}" -j ACCEPT

	echo #---------------------------------------------------------------
	echo "Allow VPN interface."
	echo #---------------------------------------------------------------
	iptables -A INPUT -i "${_VPNINT}" -j ACCEPT
	iptables -A FORWARD -i "${_VPNINT}" -j ACCEPT
	iptables -A OUTPUT -o "${_VPNINT}" -j ACCEPT

	#---------------------------------------------------------------
	echo "Forward all traffic to this host through the VPN."
	#---------------------------------------------------------------
	sysctl -w net.ipv4.ip_forward=1 >/dev/null
	iptables -A FORWARD -o "${_VPNINT}" -i "${_LOCALINT}" -s "${_LOCALNET}/${_LOCALSUB}" -m conntrack --ctstate NEW -j ACCEPT
	iptables -A FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
	iptables -t nat -A POSTROUTING -o "${_VPNINT}" -j MASQUERADE
	iptables-save | tee /etc/iptables.sav >/dev/null
}



start_vpn_nat_monitor () {

	# Check that the required packages are installed and add them if not.
	software::check_native_package_dependency byobu
	software::check_native_package_dependency speedometer

	byobu new-session -d -s "$USER"

	# status screen
	byobu rename-window -t $USER:0 'status'
	byobu send-keys "htop" C-m

	byobu split-window -v
	byobu-tmux select-pane -t 1
	byobu send-keys "$@" C-m

	# netmon
	#byobu-tmux select-pane -t 2
	byobu split-window -h
	byobu send-keys "speedometer -r ${_VPNINT} -t ${_VPNINT}" C-m

	# Select first window 0 and split horizontally
	byobu-tmux select-pane -t 0
	byobu split-window -h
	byobu send-keys "cat  /home/$SUDO_USER/bin/FW_README" C-m

	# Create new window
	byobu new-window -t "$USER":1 -n 'CMD'

	# Set default window as the dev split plane
	byobu select-window -t "$USER":0

	# Attach to the session you just created
	byobu attach-session -t "$USER"

}



run_nordvpn() {
	if hash nordvpn 2>/dev/null; then
		nordvpn connect

	else
		if ($rtd_menu --title "$_branding helper: Get VPN" --yesno "Nordvpn is not installed... I need to download it from the internet. Is this OK?" 8 78); then
			echo "OK Thank you. Geting Nordvpn from the website..."
			if hash rpm 2>/dev/null; then
				sudo rpm -ivh "$NORDVPN_RPM" || sudo yum update -y
				sudo yum install -y nordvpn && nordvpn connect || err_nordvpn_install
			elif hash apt 2>/dev/null; then
				tmp_pkg=$(mktemp)
				if wget -q "$NORDVPN_DEB" -O "$tmp_pkg"; then
					sudo dpkg -i "$tmp_pkg" || true
					rm -f "$tmp_pkg"
					sudo apt-get -f install -y
					sudo apt-get update
					sudo DEBIAN_FRONTEND=noninteractive apt-get -y install nordvpn || err_nordvpn_install
					nordvpn connect || err_nordvpn_install
				else
					err_nordvpn_install
				fi
			else
				err_nordvpn_install
			fi
		else
			$rtd_menu --title "$_branding helper: Get VPN" --msgbox "Nordvpn was not installed... Without the VPN software I cannot continue. My appologies, but I must exit." 8 78
			_cleanup
			exit
		fi

	fi
}

detect_vpn_client() {
	if command -v nordvpn >/dev/null 2>&1; then
		echo "nordvpn"
	elif command -v mullvad >/dev/null 2>&1; then
		echo "mullvad"
	elif command -v protonvpn-cli >/dev/null 2>&1 || command -v protonvpn >/dev/null 2>&1; then
		echo "protonvpn"
	else
		echo ""
	fi
}

get_codename() {
	if command -v lsb_release >/dev/null 2>&1; then
		lsb_release -cs
	elif [[ -r /etc/os-release ]]; then
		. /etc/os-release
		echo "${VERSION_CODENAME:-stable}"
	else
		echo "stable"
	fi
}

ensure_mullvad_repo() {
	if command -v apt-get >/dev/null 2>&1; then
		if [[ ! -f /etc/apt/sources.list.d/mullvad.list ]]; then
			curl -fsSL https://repository.mullvad.net/deb/mullvad-keyring.asc | gpg --dearmor -o /usr/share/keyrings/mullvad-keyring.gpg
			echo "deb [signed-by=/usr/share/keyrings/mullvad-keyring.gpg] https://repository.mullvad.net/deb/stable $(get_codename) main" | tee /etc/apt/sources.list.d/mullvad.list >/dev/null
			apt-get update
		fi
	elif command -v dnf >/dev/null 2>&1 || command -v yum >/dev/null 2>&1; then
		if [[ ! -f /etc/yum.repos.d/mullvad.repo ]]; then
			cat >/etc/yum.repos.d/mullvad.repo <<'EOF'
[mullvad]
name=Mullvad VPN
baseurl=https://repository.mullvad.net/rpm/stable/$basearch
enabled=1
gpgcheck=1
gpgkey=https://repository.mullvad.net/rpm/mullvad-keyring.asc
EOF
		fi
	fi
}

ensure_protonvpn_repo() {
	if command -v apt-get >/dev/null 2>&1; then
		if [[ ! -f /etc/apt/sources.list.d/protonvpn.list ]]; then
			curl -fsSL https://repo.protonvpn.com/debian/public_key.asc -o /usr/share/keyrings/protonvpn.asc
			echo "deb [signed-by=/usr/share/keyrings/protonvpn.asc] https://repo.protonvpn.com/debian stable main" | tee /etc/apt/sources.list.d/protonvpn.list >/dev/null
			apt-get update
		fi
	fi
}

install_vpn_client() {
	local choice="$1"
	case "$choice" in
		nordvpn)
			run_nordvpn
			;;
		mullvad)
			if hash apt-get >/dev/null 2>&1; then
				ensure_mullvad_repo
				install_software mullvad-vpn
			elif hash yum >/dev/null 2>&1 || hash dnf >/dev/null 2>&1; then
				ensure_mullvad_repo
				install_software mullvad-vpn
			else
				err_nordvpn_install
			fi
			;;
		protonvpn)
			if hash apt-get >/dev/null 2>&1; then
				ensure_protonvpn_repo
				install_software protonvpn-cli
			elif hash yum >/dev/null 2>&1 || hash dnf >/dev/null 2>&1; then
				install_software protonvpn-cli
			else
				err_nordvpn_install
			fi
			;;
		*)
			return 1
			;;
	esac
}

connect_vpn_client() {
	local choice="$1"
	case "$choice" in
		nordvpn)
			nordvpn connect
			;;
		mullvad)
			mullvad connect
			;;
		protonvpn)
			if command -v protonvpn-cli >/dev/null 2>&1; then
				protonvpn-cli c -f
			else
				protonvpn c -f
			fi
			;;
		*)
			return 1
			;;
	esac
}

run_vpn() {
	local vpn_client choice=""
	vpn_client=$(detect_vpn_client)

	if [[ -z "$vpn_client" ]]; then
		# Prompt user to install a client
		if [[ -n "${rtd_menu:-}" ]]; then
			choice=$($rtd_menu --menu "Select VPN client to install" 15 70 3 \
				"nordvpn" "NordVPN" \
				"mullvad" "Mullvad VPN" \
				"protonvpn" "Proton VPN" \
				3>&1 1>&2 2>&3)
		else
			read -p "No VPN client found. Install which? [nordvpn/mullvad/protonvpn]: " choice
		fi
		choice=${choice,,}
		if [[ -z "$choice" ]]; then
			echo "No VPN client selected; exiting."
			exit 1
		fi
		if ! install_vpn_client "$choice"; then
			echo "Failed to install VPN client: $choice"
			exit 1
		fi
		vpn_client="$choice"
	fi

	connect_vpn_client "$vpn_client" || {
		echo "Failed to start VPN client: $vpn_client"
		exit 1
	}
}



_cleanup () {
	_branding=
}



err_nordvpn_install () {
	$rtd_menu --title "$_branding helper: PROBLEM" --msgbox "	I was not able to install the selected VPN client for you. Please do it manually and try again" 0 110
	_cleanup
	exit 1
}



err_no_menu_system_available () {
	echo "There is no menu or dialog software installed on this system..."
	echo "If you want to use $me you must ensure that whiptail or dialog is installed."
	read -p "Press [ENTER] to exit... "
	_cleanup
	exit 1
}



check_menu_availability () {
	# First discover what menu system is installed. Some systems use "dialog" and
	# other systems use whiptail for the terminal to show menus and dialogs.
	# If nothing is found, then make sure it is available before continuing.
	if hash whiptail >/dev/null 2>&1 ; then
		export rtd_menu=whiptail
	elif hash dialog >/dev/null 2>&1 ; then
		export rtd_menu=dialog
	else
		err_no_menu_system_found
	fi

}



err_no_menu_system_found () {
	echo -e "$RED There is no way to display menus on this system $ENDCOLOR"
	echo -e "This is required to display the choices of countries..."
	echo -e "$YELLOW May I attepmpt to install this ability to your system? $ENDCOLOR"
	read -p "Add software: (y/n)?" choice
	case "$choice" in
	  y|Y ) install_software whiptail ;;
	  n|N ) err_no_menu_system_available ;;
	  * ) echo "Invalid Selection" && err_no_menu_system_found ;;
	esac
}



install_software () {
	if hash pkcon 2>/dev/null; then
		sudo pkcon -y  install "$@"
	elif hash yum 2>/dev/null; then
		sudo yum -y  install "$@"
	elif hash zypper 2>/dev/null; then
		sudo zypper install -y "$@"
	elif hash apt-get 2>/dev/null; then
		export DEBIAN_FRONTEND=noninteractive
		sudo apt-get -y -qq --allow-change-held-packages --ignore-missing install "$@"
	else
		echo -e "$YELLOW This system does not seem to have a software managment system $ENDCOLOR"
		err_no_menu_system_available
		_cleanup
		exit 1
	fi
}



#::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
#::::::::::::::                                          ::::::::::::::::::::::
#::::::::::::::          Connect VPN                     ::::::::::::::::::::::
#::::::::::::::                                          ::::::::::::::::::::::
#::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
#
# This script routes LAN traffic through a VPN and fails closed if the VPN drops.
# Ensure you have valid VPN credentials/config prior to running.

pushd "/home/$SUDO_USER" || echo "Failed to enter /home/$SUDO_USER "
find_active_newtork_interface
find_active_bridge_interface
derive_local_network
check_menu_availability
setup_routing_for_vpn
run_vpn
